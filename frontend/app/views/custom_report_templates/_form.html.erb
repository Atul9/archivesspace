<%= render_aspace_partial :partial => "shared/form_messages", :locals => {:form => form} %>

<fieldset>

	<% record_types = @custom_data.keys %>
	<% record_types.delete('global') %>

	<h3><%= I18n.t "custom_report_template._frontend.section.template_information" %></h3>

	<%= form.label_and_textfield "name", :required => true %>
	<%= form.label_and_textarea "description" %>

	<div class="form-group">
		<%= form.label 'record_type', :class => "col-sm-2 control-label" %>
		
		<div class="col-sm-9">
			<%= select_tag "custom_report_template[data][custom_record_type]", options_for_select(record_types.collect {|record_type| [I18n.t("#{record_type}._plural"), record_type]}), {:id => "custom_record_type", :class => "form-control"} %>
		</div>
	</div>

	<h3><%= I18n.t "custom_report_template._frontend.section.basic_information_fields" %></h3>

	<% enums = JSONModel(:enumeration).all %>

	<% users = [] %>
	<% JSONModel::HTTP::get_json("/users", :all_ids => true).each do |id| %>
		<% user = JSONModel(:user).find(id) %>
		<% users.push([user.name, user.username]) %>
	<% end %>

	<% record_types.each do |record_type| %>

		<% fields = (@custom_data[record_type]['fields'] + @custom_data['global']['fields']) %>
		<div class="record_type <%= record_type %>">

			<% fields.each do |field| %>
				<% translation_scope = field['translation_scope'] || record_type %>
				<% field_name = field['name'] %>

				<div class="panel panel-default">

					<div class="panel-heading">
						<%= I18n.t("#{translation_scope}.#{field['alias'] || field_name}", :default => field_name) %>
					</div>

					<div style="padding-bottom: 10px;">
						<div class="form-group">
							<%= form.label 'display', :class => "col-sm-2 control-label" %>
							<div class="col-sm-9 checkbox">
								<%= check_box_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][include]" %>
							</div>
						</div>

						<% case field['data_type'] %>
						<% when 'Date' %>
							<div class="form-group">
								<%= form.label "narrow_by", :class => "col-sm-2 control-label" %>
								<div class="col-sm-9 checkbox">
									<%= check_box_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][narrow_by]" %>
								</div>
							</div>

							<div class="form-group">
								<%= form.label 'start_date', :class => 'col-sm-2 control-label' %>
								<div class="col-sm-9">
									<%= text_field_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][range_start]", nil,  :class => 'date-field form-control', :'data-format' => 'yyyy-mm-dd', :placeholder => 'yyyy-mm-dd' %>
								</div>
							</div>

							<div class="form-group">
								<%= form.label 'end_date', :class => 'col-sm-2 control-label' %>
								<div class="col-sm-9">
									<%= text_field_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][range_end]", nil,  :class => 'date-field form-control', :'data-format' => 'yyyy-mm-dd', :placeholder => 'yyyy-mm-dd'  %>
								</div>
							</div>

						<% when 'AgentType' %>
							<div class="form-group">
								<%= form.label "narrow_by", :class => "col-sm-2 control-label" %>
								<div class="col-sm-9 checkbox">
									<%= check_box_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][narrow_by]" %>
								</div>
							</div>

							<div class="form-group">
								<%= form.label 'values', :class => 'col-sm-2 control-label' %>
								<% agent_types = ['agent_family', 'agent_person', 'agent_corporate_entity', 'agent_software'] %>
								<div class="col-sm-9">
									<%= select_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][values]", options_for_select(agent_types.collect {|agent_type| [I18n.t("agent.agent_type.#{agent_type}"), agent_type]}), :multiple => true, :style => "width: auto; max-with: 100%;", :class=>"form-control" %>
								</div>
							</div>
						<% when 'Boolean' %>
							<div class="form-group">
								<%= form.label "narrow_by", :class => "col-sm-2 control-label" %>
								<div class="col-sm-9 checkbox">
									<%= check_box_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][narrow_by]" %>
								</div>
							</div>

							<div class="form-group">
								<%= form.label "value", :class => "col-sm-2 control-label" %>
								<div class="col-sm-9">
									<%= select_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][value]", options_for_select([[I18n.t('custom_report_template.true'), true], [I18n.t('custom_report_template.false'), false]]), :style => "width: auto; max-with: 100%;", :class=>"form-control" %>
								</div>
							</div>
						<% when 'Enum' %>
							<% enum_name = field['enum_name'] || "#{record_type}_#{field_name}" %>
							<% enum = enums.find {|obj| obj.name == enum_name} %>
							<% if enum %>
								<% options = enum['enumeration_values'] %>
								<div class="form-group">
									<%= form.label "narrow_by", :class => "col-sm-2 control-label" %>
									<div class="col-sm-9 checkbox">
										<%= check_box_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][narrow_by]" %>
									</div>
								</div>

								<div class="form-group">
									<%= form.label 'values', :class => 'col-sm-2 control-label' %>
									<div class="col-sm-9">
										<%= select_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][values]", options_for_select(options.collect {|value| [I18n.t("enumerations.#{enum_name}.#{value['value']}", :default => value['value']), value['id']]}), :multiple => true, :style => "width: auto; max-with: 100%;", :class=>"form-control" %>
									</div>
								</div>
							<% end %>
						<% when 'User' %>
							<div class="form-group">
								<%= form.label "narrow_by", :class => "col-sm-2 control-label" %>
								<div class="col-sm-9 checkbox">
									<%= check_box_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][narrow_by]" %>
								</div>
							</div>

							<div class="form-group">
								<%= form.label 'values', :class => 'col-sm-2 control-label' %>
								<div class="col-sm-9">
									<%= select_tag "custom_report_template[data][#{record_type}][fields][#{field_name}][values]", options_for_select(users), :multiple => true, :style => "width: auto; max-with: 100%;", :class=>"form-control" %>
								</div>
							</div>
						<% end %>
					</div>
				</div>
			<% end %>

			<h3>Linked Records</h4>
			<% @custom_data[record_type]['subreports'].each do |subreport| %>
				<% field_name = subreport['name'] %>
				<% translation = subreport['translation'] || "#{field_name}._plural" %>
				<div class="form-group">
					<label class="col-sm-2 control-label"><%= I18n.t(translation, :default => field_name) %></label>
					<div class="col-sm-9 checkbox">
						<%= check_box_tag "custom_report_template[data][#{record_type}][subreports][#{field_name}][include]" %>
					</div>
				</div>
			<% end %>

			<h3><%= I18n.t "custom_report_template._frontend.section.sort_by" %></h4>
			<div class="form-group">
				<%= form.label 'field', :class => 'col-sm-2 control-label' %>
				<div class="col-sm-9">
					<select id="sort_by" name="custom_report_template[data][<%= record_type %>][sort_by]" class="form-control">
						<option value = ''></option>
						<% fields.each do |field| %>
							<% if field['sortable'] %>
								<% translation_scope = field['translation_scope'] || record_type %>
								<option value="<%= field['name'] %>">
									<%= I18n.t("#{translation_scope}.#{field['alias'] ||field['name']}", :default => field['name']) %>
								</option>
							<% end %>
						<% end %>
					</select>
				</div>
			</div>
		</div>
	<% end %>
</fieldset>

